{"ast":null,"code":"import _objectSpread from\"C:/Users/Administrator/Desktop/bika/bika/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from\"react\";import{Box,Typography,Card,Table,TableBody,TableCell,TableContainer,TableHead,TableRow,IconButton,Chip,InputAdornment,Pagination,TextField as MuiTextField,styled,TableSortLabel,Dialog,DialogTitle,DialogContent,DialogActions,Button,Alert,CircularProgress,Grid,Fab}from\"@mui/material\";import{Edit as EditIcon,Delete as DeleteIcon,Search as SearchIcon,Add as AddIcon,Business as DepartmentIcon}from\"@mui/icons-material\";import{tokens}from\"../../theme/theme\";import{departmentService}from\"../../services/api\";import{useAuth}from\"../../context/AuthContext\";import{hasRole}from\"../../utils/roleUtils\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const StyledCard=styled(Card)(_ref=>{let{theme}=_ref;return{borderRadius:16,boxShadow:\"0 4px 12px rgba(0, 0, 0, 0.05)\"};});const StyledTableCell=styled(TableCell)(_ref2=>{let{theme}=_ref2;return{borderBottom:\"1px solid \".concat(theme.palette.divider)};});const StatusChip=styled(Chip)(_ref3=>{let{status,theme}=_ref3;return{backgroundColor:status===\"active\"?theme.palette.mode===\"light\"?tokens.secondary.light:tokens.secondary.main:theme.palette.grey[300],color:status===\"active\"?theme.palette.mode===\"light\"?tokens.secondary.dark:theme.palette.getContrastText(tokens.secondary.main):theme.palette.getContrastText(theme.palette.grey[300]),borderRadius:8,fontWeight:500};});const Departments=()=>{const{user:currentUser}=useAuth();// State\nconst[departments,setDepartments]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[searchTerm,setSearchTerm]=useState(\"\");const[currentPage,setCurrentPage]=useState(1);const[departmentsPerPage]=useState(10);const[sortBy,setSortBy]=useState(\"name\");const[sortOrder,setSortOrder]=useState(\"asc\");// Dialog states\nconst[editDialogOpen,setEditDialogOpen]=useState(false);const[addDialogOpen,setAddDialogOpen]=useState(false);const[editingDepartment,setEditingDepartment]=useState(null);const[deleteDialogOpen,setDeleteDialogOpen]=useState(false);const[departmentToDelete,setDepartmentToDelete]=useState(null);// Form states\nconst[formData,setFormData]=useState({name:'',code:'',description:'',companyId:(currentUser===null||currentUser===void 0?void 0:currentUser.companyId)||1});// Load initial data\nuseEffect(()=>{loadData();},[currentUser]);const loadData=async()=>{try{setLoading(true);setError(null);console.log('Loading departments data...',{currentUser});if(hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'SUPER_ADMIN')){console.log('Loading all departments for SUPER_ADMIN');const departmentsData=await departmentService.getDepartments();console.log('Loaded departments:',departmentsData);setDepartments(departmentsData);}else if(hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'COMPANY_ADMIN')&&currentUser!==null&&currentUser!==void 0&&currentUser.companyId){console.log('Loading departments for COMPANY_ADMIN, companyId:',currentUser.companyId);const departmentsData=await departmentService.getDepartmentsByCompany(currentUser.companyId);console.log('Loaded company departments:',departmentsData);setDepartments(departmentsData);}else{console.log('User does not have permission to view departments');setError(\"You don't have permission to view departments\");}}catch(err){var _err$response,_err$response$data;console.error('Error loading departments:',err);setError(((_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||err.message||'Failed to load departments');}finally{setLoading(false);}};// Filtering and sorting\nconst filteredDepartments=departments.filter(department=>department.name.toLowerCase().includes(searchTerm.toLowerCase())||department.code.toLowerCase().includes(searchTerm.toLowerCase())||department.description&&department.description.toLowerCase().includes(searchTerm.toLowerCase()));const sortedDepartments=[...filteredDepartments].sort((a,b)=>{const aValue=a[sortBy];const bValue=b[sortBy];// Handle undefined values\nif(aValue===undefined&&bValue===undefined)return 0;if(aValue===undefined)return sortOrder===\"asc\"?1:-1;if(bValue===undefined)return sortOrder===\"asc\"?-1:1;if(typeof aValue==='string'&&typeof bValue==='string'){if(aValue<bValue)return sortOrder===\"asc\"?-1:1;if(aValue>bValue)return sortOrder===\"asc\"?1:-1;}return 0;});// Pagination\nconst totalPages=Math.ceil(sortedDepartments.length/departmentsPerPage);const paginatedDepartments=sortedDepartments.slice((currentPage-1)*departmentsPerPage,currentPage*departmentsPerPage);// Event handlers\nconst handleSort=column=>{if(sortBy===column){setSortOrder(sortOrder===\"asc\"?\"desc\":\"asc\");}else{setSortBy(column);setSortOrder(\"asc\");}};const handleSearchChange=e=>{setSearchTerm(e.target.value);setCurrentPage(1);};const handlePageChange=(_,value)=>{setCurrentPage(value);};// CRUD operations\nconst handleAddDepartment=()=>{setFormData({name:'',code:'',description:'',companyId:(currentUser===null||currentUser===void 0?void 0:currentUser.companyId)||1});setAddDialogOpen(true);};const handleEditDepartment=department=>{setEditingDepartment(department);setFormData({name:department.name,code:department.code,description:department.description||'',companyId:department.companyId,parentId:department.parentId});setEditDialogOpen(true);};const handleDeleteDepartment=department=>{setDepartmentToDelete(department);setDeleteDialogOpen(true);};// Form handlers\nconst handleFormChange=(field,value)=>{setFormData(prev=>_objectSpread(_objectSpread({},prev),{},{[field]:value}));};const handleSaveDepartment=async()=>{try{// Basic validation\nif(!formData.name.trim()){setError('Department name is required');return;}if(!formData.code.trim()){setError('Department code is required');return;}if(editingDepartment){// Update existing department\nawait departmentService.updateDepartment(editingDepartment.id,{name:formData.name,code:formData.code,description:formData.description,companyId:formData.companyId,parentId:formData.parentId,isActive:true});}else{// Create new department\nawait departmentService.createDepartment({name:formData.name,code:formData.code,description:formData.description,companyId:formData.companyId,parentId:formData.parentId,isActive:true});}setEditDialogOpen(false);setAddDialogOpen(false);setEditingDepartment(null);await loadData();}catch(err){var _err$response2,_err$response2$data;console.error('Error saving department:',err);setError(((_err$response2=err.response)===null||_err$response2===void 0?void 0:(_err$response2$data=_err$response2.data)===null||_err$response2$data===void 0?void 0:_err$response2$data.message)||'Failed to save department');}};const handleConfirmDelete=async()=>{if(!departmentToDelete)return;try{await departmentService.deleteDepartment(departmentToDelete.id);setDeleteDialogOpen(false);setDepartmentToDelete(null);await loadData();}catch(err){var _err$response3,_err$response3$data;setError(((_err$response3=err.response)===null||_err$response3===void 0?void 0:(_err$response3$data=_err$response3.data)===null||_err$response3$data===void 0?void 0:_err$response3$data.message)||'Failed to delete department');}};const handleCloseDialogs=()=>{setEditDialogOpen(false);setAddDialogOpen(false);setDeleteDialogOpen(false);setEditingDepartment(null);setDepartmentToDelete(null);setError(null);};if(loading){return/*#__PURE__*/_jsxs(Box,{display:\"flex\",justifyContent:\"center\",alignItems:\"center\",minHeight:\"60vh\",children:[/*#__PURE__*/_jsx(CircularProgress,{}),/*#__PURE__*/_jsx(Typography,{variant:\"h6\",sx:{ml:2},children:\"Loading departments...\"})]});}if(error&&!departments.length){return/*#__PURE__*/_jsxs(Box,{p:3,children:[/*#__PURE__*/_jsx(Alert,{severity:\"error\",children:error}),/*#__PURE__*/_jsx(Button,{onClick:loadData,variant:\"contained\",sx:{mt:2},children:\"Retry\"})]});}return/*#__PURE__*/_jsxs(Box,{sx:{p:3},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:\"flex\",justifyContent:\"space-between\",alignItems:\"center\",mb:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",fontWeight:\"bold\",children:\"Departments\"}),(hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'SUPER_ADMIN')||hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'COMPANY_ADMIN'))&&/*#__PURE__*/_jsx(Fab,{color:\"primary\",\"aria-label\":\"add department\",onClick:handleAddDepartment,sx:{position:\"fixed\",bottom:24,right:24},children:/*#__PURE__*/_jsx(AddIcon,{})})]}),error&&/*#__PURE__*/_jsx(Alert,{severity:\"error\",onClose:()=>setError(null),sx:{mb:2},children:error}),/*#__PURE__*/_jsx(StyledCard,{children:/*#__PURE__*/_jsxs(Box,{sx:{p:2},children:[/*#__PURE__*/_jsx(MuiTextField,{placeholder:\"Search departments...\",value:searchTerm,onChange:handleSearchChange,InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsx(SearchIcon,{})})},sx:{mb:2,width:\"100%\",maxWidth:400}}),/*#__PURE__*/_jsx(TableContainer,{children:/*#__PURE__*/_jsxs(Table,{children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(TableSortLabel,{active:sortBy===\"name\",direction:sortBy===\"name\"?sortOrder:\"asc\",onClick:()=>handleSort(\"name\"),children:\"Name\"})}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(TableSortLabel,{active:sortBy===\"code\",direction:sortBy===\"code\"?sortOrder:\"asc\",onClick:()=>handleSort(\"code\"),children:\"Code\"})}),/*#__PURE__*/_jsx(StyledTableCell,{children:\"Description\"}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(TableSortLabel,{active:sortBy===\"isActive\",direction:sortBy===\"isActive\"?sortOrder:\"asc\",onClick:()=>handleSort(\"isActive\"),children:\"Status\"})}),/*#__PURE__*/_jsx(StyledTableCell,{children:\"Actions\"})]})}),/*#__PURE__*/_jsx(TableBody,{children:paginatedDepartments.length===0?/*#__PURE__*/_jsx(TableRow,{children:/*#__PURE__*/_jsx(StyledTableCell,{colSpan:5,align:\"center\",children:/*#__PURE__*/_jsx(Typography,{variant:\"body1\",color:\"text.secondary\",sx:{py:4},children:searchTerm?'No departments found matching your search.':'No departments found.'})})}):paginatedDepartments.map(department=>/*#__PURE__*/_jsxs(TableRow,{hover:true,children:[/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center'},children:[/*#__PURE__*/_jsx(DepartmentIcon,{sx:{mr:1,color:'text.secondary'}}),/*#__PURE__*/_jsx(Typography,{fontWeight:\"medium\",children:department.name})]})}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{fontFamily:'monospace'},children:department.code})}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:department.description||'No description'})}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(StatusChip,{label:department.isActive?\"Active\":\"Inactive\",status:department.isActive?\"active\":\"inactive\"})}),/*#__PURE__*/_jsx(StyledTableCell,{children:/*#__PURE__*/_jsx(Box,{sx:{display:\"flex\",gap:1},children:(hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'SUPER_ADMIN')||hasRole(currentUser===null||currentUser===void 0?void 0:currentUser.role,'COMPANY_ADMIN')&&department.companyId===(currentUser===null||currentUser===void 0?void 0:currentUser.companyId))&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(IconButton,{onClick:()=>handleEditDepartment(department),size:\"small\",color:\"primary\",children:/*#__PURE__*/_jsx(EditIcon,{fontSize:\"small\"})}),/*#__PURE__*/_jsx(IconButton,{onClick:()=>handleDeleteDepartment(department),size:\"small\",color:\"error\",children:/*#__PURE__*/_jsx(DeleteIcon,{fontSize:\"small\"})})]})})})]},department.id))})]})}),totalPages>1&&/*#__PURE__*/_jsx(Box,{sx:{display:\"flex\",justifyContent:\"center\",mt:3},children:/*#__PURE__*/_jsx(Pagination,{count:totalPages,page:currentPage,onChange:handlePageChange,color:\"primary\"})})]})}),/*#__PURE__*/_jsxs(Dialog,{open:addDialogOpen,onClose:handleCloseDialogs,maxWidth:\"md\",fullWidth:true,children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Add New Department\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,sx:{mt:1},children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Department Name\",value:formData.name,onChange:e=>handleFormChange('name',e.target.value),fullWidth:true,required:true})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Department Code\",value:formData.code,onChange:e=>handleFormChange('code',e.target.value),fullWidth:true,required:true,helperText:\"Unique identifier for the department\"})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Description\",value:formData.description,onChange:e=>handleFormChange('description',e.target.value),fullWidth:true,multiline:true,rows:3,helperText:\"Optional description of the department\"})})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleCloseDialogs,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleSaveDepartment,variant:\"contained\",children:\"Add Department\"})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:editDialogOpen,onClose:handleCloseDialogs,maxWidth:\"md\",fullWidth:true,children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Edit Department\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:2,sx:{mt:1},children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Department Name\",value:formData.name,onChange:e=>handleFormChange('name',e.target.value),fullWidth:true,required:true})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:6,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Department Code\",value:formData.code,onChange:e=>handleFormChange('code',e.target.value),fullWidth:true,required:true,helperText:\"Unique identifier for the department\"})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,children:/*#__PURE__*/_jsx(MuiTextField,{label:\"Description\",value:formData.description,onChange:e=>handleFormChange('description',e.target.value),fullWidth:true,multiline:true,rows:3,helperText:\"Optional description of the department\"})})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleCloseDialogs,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleSaveDepartment,variant:\"contained\",children:\"Save Changes\"})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:deleteDialogOpen,onClose:handleCloseDialogs,children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Confirm Delete\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsxs(Typography,{children:[\"Are you sure you want to delete department \\\"\",departmentToDelete===null||departmentToDelete===void 0?void 0:departmentToDelete.name,\"\\\"? This action cannot be undone.\"]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleCloseDialogs,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleConfirmDelete,color:\"error\",variant:\"contained\",children:\"Delete\"})]})]})]});};export default Departments;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}